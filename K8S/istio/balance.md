##### Балансировка происходит на уровнях L4 и L7.

```
L1. Физический уровень выполняет обмен сигналами между физическими устройствами. На начальном уровне сигналы представлены в битах.
L2. Канальный уровень отвечает за физическую адресацию, биты трансформируются в кадры и получают адреса отправитель-получатель. 
L3. Сетевой уровень выполняет построение маршрута и логическую адресацию между устройствами, кадры объединяются в пакеты данных. На этом уровне учитываются все возможные неполадки в сети. За эту функцию отвечает маршрутизатор.
L4. Транспортный уровень обслуживает связь между конечными устройствами. Главные функции L4 — минимизировать задержку передачи данных и добиться целостности доставленной информации. В зависимости от протокола на транспортном уровне пакеты данных делятся по двум принципам.

Сегментирование (протокол TCP) — деление пакета на части при превышении пропускной способности сети. Деление на датаграммы (протокол UDP) — метод, при котором появляется автономная часть пакета с заголовками и адресами назначения. Датаграммы независимо доходят до конечного адресата. 

Транспортный уровень — связующее звено между двумя группами: 

Media layers, или уровни среды. L1 — L3. На них информация передается между сетевыми устройствами. 
Host layers, или уровни хоста. L4 — L7. Работают непосредственно на стационарных компьютерах или мобильных устройствах. 

На четвертом уровне работает балансировщик нагрузки, в его функции входит трекинг сетевой информации о протоколах и портах приложений, комбинирование данных с алгоритмами балансировки, подбор целевого сервера с наименьшим временем ответа.
L5. Сеансовый уровень управляет сеансом связи. В его функционале синхронизация задач, создание, поддержка в период неактивности и завершение сеансов. Начиная с L5, уровни используют чистые данные.   
L6. Уровень представления выполняет шифрование и преобразование данных в понятный для сервера и пользователя вид. 
L7. Прикладной уровень обслуживает взаимодействие пользователей и сети. Верхний уровень обеспечивает доступ к сетевым службам. Работающий на L7 протокол HTTP идентифицирует клиентские сеансы и на основе файлов cookie обеспечивает доставку запросов пользователя на один сервер. 

Алгоритмы балансировки

BGP Anycast - При любом запросе может ответить наименее загруженный сервер
Round Robin
Least connections - Каждый поступивший запрос отправляется серверу с наименьшим количеством активных подключений

TCP–TCP     — классическая L4-балансировка,
TCP–PROXY   — информация о клиенте не теряется и передается в отдельном заголовке соединения,
UDP–UDP     — UDP-протокол быстрее, чем TCP, но менее надежен,
HTTP–HTTP   — L7-балансировка,
HTTPS–HTTP  — L7-балансировка с шифрованием и терминацией SSL-сертификата на балансировщике.

Direct Server Return, DSR когда ответ от сервера идет к клиенту напрямую, а не через устройство балансировки
Доступность бэкендов определяется двумя:
 -  активный (keepalives, балансировщик сам опрашивает серверы) и
 - пассивный (In-Band, контролируются текущие соединения, ответы сервиса).
```
##### Балансировка нагрузки со стороны клиента
```
- ROUND_ROBIN
- на основе хеша IP-адреса вызывающего абонента
- также можно использовать HTTP-заголовки и cookies

Обнаружение аномалий – это способ отключения конечных точек, возвращающих плохие ответы

 DestinationRule настраивает прокси на исключение из набора баланси
ровки нагрузки любой конечной точки, давшей подряд пять ошибок, на период 
не менее трех минут. Каждую минуту прокси сканирует набор всех конечных 
точек, чтобы решить, нужно ли исключать какие-то конечные точки и можно 
ли вернуть исключенные точки обратно в набор для балансировки
```
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: foo-default
spec:
  host: foo.default.svc.cluster.local
  trafficPolicy:
    outlierDetection:
      consecutiveErrors: 5 
      interval: 1m
      baseEjectionTime: 3m
```
```
Политика повторных попыток, определенная в VirtualService, согласуется 
с настройками пула соединений, определенными в DestinationRule получателя, 
чтобы контролировать общее количество одновременных незавершенных попыток получить ответ от этого получателя.

Тайм-аут можно присвоить любому HTTP-маршруту в VirtualService
```

##### Имитация ошибок

```
Istio позволяет настраивать имитацию ошибок для HTTP-трафика, вводить 
произвольные задержки или возвращать определенные коды ответа (например, 500) для определенного процента трафика

VirtualService вводит 5-секундную за держку для всего трафика

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: foo-default
spec:
  hosts:
  – foo.default.svc.cluster.local
  http:
  – route:
	– destination:
        host: foo.default.svc.cluster.local
    fault:
      delay:
        fixedDelay: 5s
        percentage: 100
```

```
сервер отвечает на 10 % запросов кодом ошибки 500
```

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: foo-default
spec:
  hosts:
  – foo.default.svc.cluster.local
  http:
  – route:
	– destination:
        host: foo.default.svc.cluster.local
    fault:
      abort:
        httpStatus: 500
        percentage: 10
```